"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[231],{2231:(e,t,r)=>{r.r(t),r.d(t,{Whiteboard:()=>d});var n=r(7573),c=r(7653),u=r(618),l=r(2148),o=r(8107),i=r(9264),a=r(480);let s=r(7580).env.NEXT_PUBLIC_WS_URL||"http://localhost:3001",d=e=>{let{roomId:t}=e,r=(0,c.useRef)(null),d=(0,c.useRef)(null),f=(0,c.useRef)(null),h=(0,c.useRef)(!1),w=(0,c.useRef)(!1),g=(0,c.useRef)(0),E=(0,c.useRef)(0),v=(0,c.useRef)(null),p=(0,c.useRef)(null),b=(0,c.useRef)(o.q.SELECTION),y=(0,c.useRef)("#000000"),R=(0,c.useRef)(2),x=(0,c.useRef)(1),q=(0,c.useRef)([]),C=(0,c.useRef)(-1),O=(0,c.useRef)(!1),{activeTool:m,strokeColor:N,strokeWidth:L,fillColor:A,roughness:I,opacity:S,isDarkMode:k,gridType:M}=(0,l.o)();(0,c.useEffect)(()=>{b.current=m,y.current=N,R.current=L,x.current=S,Y()},[m,N,L,S]);let j=e=>e.touches&&e.touches.length>0?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY},T=(e,t,r,n)=>{let c=Math.atan2(n-t,r-e),u={x:r-20*Math.cos(c-Math.PI/6),y:n-20*Math.sin(c-Math.PI/6)},l={x:r-20*Math.cos(c+Math.PI/6),y:n-20*Math.sin(c+Math.PI/6)};return"M ".concat(e," ").concat(t," L ").concat(r," ").concat(n," M ").concat(r," ").concat(n," L ").concat(u.x," ").concat(u.y," M ").concat(r," ").concat(n," L ").concat(l.x," ").concat(l.y)},D=(e,t)=>{let r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return r?"rgba(".concat(parseInt(r[1],16),", ").concat(parseInt(r[2],16),", ").concat(parseInt(r[3],16),", ").concat(t,")"):e},P=()=>{if(!d.current)return;let e=d.current,t=k?"#18181b":"#ffffff",r=k?"#3f3f46":"#e5e7eb";if(M===o.t.NONE){e.backgroundColor=t,e.requestRenderAll();return}let n="";M===o.t.LINES?n='<defs><pattern id="grid" width="'.concat(20,'" height="').concat(20,'" patternUnits="userSpaceOnUse"><path d="M ').concat(20," 0 L 0 0 0 ").concat(20,'" fill="none" stroke="').concat(r,'" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(#grid)" />'):M===o.t.DOTS&&(n='<defs><pattern id="dots" width="'.concat(20,'" height="').concat(20,'" patternUnits="userSpaceOnUse"><circle cx="1" cy="1" r="1" fill="').concat(r,'" /></pattern></defs><rect width="100%" height="100%" fill="url(#dots)" />'));let c="data:image/svg+xml;base64,".concat(btoa('<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">'.concat(n,"</svg>"))),l=new Image;l.src=c,l.onload=()=>{d.current&&(d.current.backgroundColor=new u.cf({source:l,repeat:"repeat"}),d.current.requestRenderAll())}},U=()=>{if(O.current||!d.current)return;C.current<q.current.length-1&&(q.current=q.current.slice(0,C.current+1));let e=d.current.toObject(["id","selectable","evented","opacity"]);delete e.background,delete e.backgroundColor,delete e.backgroundImage;let t=JSON.stringify(e);q.current.push(t),C.current=q.current.length-1,q.current.length>50&&(q.current.shift(),C.current--)},X=()=>{C.current>0&&(O.current=!0,C.current--,H(q.current[C.current]))},_=()=>{C.current<q.current.length-1&&(O.current=!0,C.current++,H(q.current[C.current]))},H=async e=>{var t;if(!d.current)return;let r=JSON.parse(e);await d.current.loadFromJSON(r),P();let n=d.current;n&&n.getObjects().forEach(e=>W(e)),null===(t=d.current)||void 0===t||t.requestRenderAll(),O.current=!1};(0,c.useEffect)(()=>{let e=()=>X(),t=()=>_();return window.addEventListener("whiteboard:undo",e),window.addEventListener("whiteboard:redo",t),()=>{window.removeEventListener("whiteboard:undo",e),window.removeEventListener("whiteboard:redo",t)}},[]),(0,c.useEffect)(()=>(f.current=(0,i.io)(s),t&&f.current.emit("join-room",t),f.current.on("drawing-data",e=>{if(!d.current)return;let t=d.current.getObjects().find(t=>t.id===e.id);O.current=!0,t?(t.set(e),t.setCoords(),d.current.requestRenderAll(),O.current=!1,U()):u.D5.enlivenObjects([e]).then(t=>{var r;t.forEach(t=>{var r;t.id=e.id,W(t),null===(r=d.current)||void 0===r||r.add(t)}),null===(r=d.current)||void 0===r||r.requestRenderAll(),O.current=!1,U()})}),f.current.on("delete-object",e=>{if(!d.current)return;let t=d.current.getObjects().find(t=>t.id===e);t&&(O.current=!0,d.current.remove(t),d.current.requestRenderAll(),O.current=!1,U())}),()=>{var e;null===(e=f.current)||void 0===e||e.disconnect()}),[t]),(0,c.useEffect)(()=>{if(!r.current)return;let e=new u.Xz(r.current,{width:window.innerWidth,height:window.innerHeight,selection:!0,backgroundColor:k?"#18181b":"#ffffff",preserveObjectStacking:!0,stopContextMenu:!0,fireRightClick:!0});d.current=e,U();let n=()=>{d.current&&d.current.setDimensions({width:window.innerWidth,height:window.innerHeight})};return window.addEventListener("resize",n),e.on("mouse:wheel",function(t){let r=t.e.deltaY,n=e.getZoom();(n*=.999**r)>5&&(n=5),n<.2&&(n=.2);let c=new u.E9(t.e.offsetX,t.e.offsetY);e.zoomToPoint(c,n),t.e.preventDefault(),t.e.stopPropagation()}),e.on("mouse:down",z),e.on("mouse:move",G),e.on("mouse:up",J),e.on("path:created",B),e.on("object:modified",e=>{var r;U();let n=e.target;if(!n)return;let c=n.toObject(["id","opacity"]);null===(r=f.current)||void 0===r||r.emit("drawing-data",{roomId:t,...c})}),()=>{window.removeEventListener("resize",n),e.dispose()}},[]),(0,c.useEffect)(()=>{P()},[k,M]);let W=e=>{b.current===o.q.SELECTION?(e.evented=!0,e.selectable=!0):(e.evented=!1,e.selectable=!1)},Y=()=>{if(!d.current)return;let e=d.current,t=b.current,r=t===o.q.PENCIL;if(e.selection=t===o.q.SELECTION,e.isDrawingMode=r,r){let t=new u.pJ(e);t.width=R.current,t.color=D(y.current,x.current),e.freeDrawingBrush=t}e.getObjects().forEach(e=>W(e)),t===o.q.HAND?(e.defaultCursor="grab",e.hoverCursor="grab"):t===o.q.ERASER?(e.defaultCursor="cell",e.hoverCursor="cell"):t===o.q.SELECTION?(e.defaultCursor="default",e.hoverCursor="move"):(e.defaultCursor="crosshair",e.hoverCursor="crosshair"),e.requestRenderAll()};(0,c.useEffect)(()=>{Y()},[m,N,L,S]);let z=e=>{let t=d.current;if(!t)return;let r=e.e,n=j(r),c=t.getPointer(r),l=b.current;if(l===o.q.HAND){r.preventDefault&&r.preventDefault(),w.current=!0,g.current=n.x,E.current=n.y,t.setCursor("grabbing"),t.requestRenderAll();return}if(l===o.q.ERASER){r.preventDefault&&r.preventDefault(),h.current=!0,F(c);return}if(l===o.q.SELECTION||l===o.q.PENCIL)return;h.current=!0,v.current={x:c.x,y:c.y};let i=(0,a.Z)(),s={left:c.x,top:c.y,fill:"transparent"===A?"":A,stroke:y.current,strokeWidth:R.current,opacity:x.current,selectable:!1,evented:!1,originX:"left",originY:"top",id:i,strokeUniform:!0,cornerStyle:"circle",cornerColor:"white",borderColor:"#3b82f6",transparentCorners:!1},f=null;if(l===o.q.RECTANGLE)f=new u.UL({...s,width:0,height:0});else if(l===o.q.ROUND_RECT)f=new u.UL({...s,width:0,height:0,rx:10,ry:10});else if(l===o.q.CIRCLE)f=new u.Pj({...s,rx:0,ry:0});else if(l===o.q.TRIANGLE)f=new u.CJ({...s,width:0,height:0});else if(l===o.q.RHOMBUS)f=new u.g_([{x:.5,y:0},{x:1,y:.5},{x:.5,y:1},{x:0,y:.5}],{...s,scaleX:0,scaleY:0});else if(l===o.q.HEXAGON)f=new u.g_([{x:.25,y:0},{x:.75,y:0},{x:1,y:.5},{x:.75,y:1},{x:.25,y:1},{x:0,y:.5}],{...s,scaleX:0,scaleY:0});else if(l===o.q.LINE)f=new u.x1([c.x,c.y,c.x,c.y],s);else if(l===o.q.ARROW)f=new u.kF(T(c.x,c.y,c.x,c.y),{...s,fill:"",stroke:y.current});else if(l===o.q.TEXT){let e=new u.aW("Type here",{...s,fontFamily:"Inter, sans-serif",fontSize:24,fill:y.current});t.add(e),t.setActiveObject(e),e.enterEditing(),e.selectable=!0,e.evented=!0,h.current=!1,U();return}f&&(t.add(f),p.current=f)},G=e=>{let t=d.current;if(!t)return;let r=e.e,n=j(r),c=t.getPointer(r),l=b.current;if(l===o.q.HAND&&w.current){r.preventDefault&&r.preventDefault(),r.stopPropagation&&r.stopPropagation();let e=n.x-g.current,c=n.y-E.current;t.relativePan(new u.E9(e,c)),g.current=n.x,E.current=n.y;return}if(l===o.q.ERASER&&h.current){F(c);return}if(!h.current||!p.current||!v.current)return;let i=v.current.x,a=v.current.y,s=p.current,f=Math.min(i,c.x),R=Math.min(a,c.y),x=Math.abs(i-c.x),q=Math.abs(a-c.y);if(l===o.q.RECTANGLE||l===o.q.ROUND_RECT||l===o.q.TRIANGLE)s.set({left:f,top:R,width:x,height:q});else if(l===o.q.CIRCLE)s.set({left:f,top:R,rx:x/2,ry:q/2});else if(l===o.q.RHOMBUS||l===o.q.HEXAGON)s.set({left:f,top:R,scaleX:x,scaleY:q});else if(l===o.q.LINE)s.set({x2:c.x,y2:c.y});else if(l===o.q.ARROW){t.remove(s);let e=new u.kF(T(i,a,c.x,c.y),{...s.toObject(),fill:"",stroke:y.current});t.add(e),p.current=e}t.requestRenderAll()},J=()=>{let e=d.current;if(e){if(b.current===o.q.HAND){w.current=!1,e.setCursor("grab");return}if(h.current=!1,p.current){var r;let e=p.current;e.setCoords();let n=e.toObject(["id","opacity"]);null===(r=f.current)||void 0===r||r.emit("drawing-data",{roomId:t,...n}),U(),p.current=null}}},B=e=>{var r;let n=e.path;n.set({id:(0,a.Z)(),opacity:x.current,selectable:b.current===o.q.SELECTION,evented:b.current===o.q.SELECTION});let c=n.toObject(["id","opacity"]);null===(r=f.current)||void 0===r||r.emit("drawing-data",{roomId:t,...c}),U()},F=e=>{let t=d.current;if(!t)return;let r=30/t.getZoom(),n=t.getObjects(),c=!1;for(let t=n.length-1;t>=0;t--){let l=n[t],o=l.intersectsWithRect(new u.E9(e.x-r/2,e.y-r/2),new u.E9(e.x+r/2,e.y+r/2)),i=l.containsPoint(new u.E9(e.x,e.y));(o||i)&&(Z(l),c=!0)}c&&U()},Z=e=>{var r;if(!d.current)return;let n=e.id;d.current.remove(e),d.current.requestRenderAll(),null===(r=f.current)||void 0===r||r.emit("delete-object",{roomId:t,id:n})};return(0,n.jsx)("div",{className:"w-full h-full relative overflow-hidden bg-neutral-100 dark:bg-zinc-900",style:{touchAction:"none"},children:(0,n.jsx)("canvas",{ref:r})})}}}]);